# 构建阶段
FROM golang:alpine as builder

# 设置工作目录
WORKDIR /build

# 复制必要的文件
COPY main_refactored.go .
COPY go_refactored.mod go.mod
COPY config_refactored.yaml config.yaml

# 安装依赖并构建
RUN apk add --no-cache --virtual .build-deps \
    git \
    ca-certificates \
    build-base \
    binutils \
    && go mod download \
    && CGO_ENABLED=0 GOOS=linux go build -o sonic main_refactored.go \
    && echo "构建完成，二进制文件大小:" \
    && du -h sonic

# 运行阶段
FROM alpine:latest as prod

# 安装必要的系统工具
RUN apk add --no-cache tzdata ca-certificates \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone

# 创建应用目录
RUN mkdir -p /app/conf /app/resources

# 复制构建产物
COPY --from=builder /build/sonic /app/
COPY --from=builder /build/config.yaml /app/conf/
COPY --from=builder /build/config.yaml /app/conf/config.yaml

# 设置工作目录
WORKDIR /app

# 暴露端口
EXPOSE 8080

# 启动应用
CMD ["./sonic"]
